quest guild_building_melt begin
	state start begin
		function GetOreRefineCost(cost)
			if pc.get_empire() != npc.get_empire() then
				return 3 * cost
			end

			if pc.get_guild() == npc.get_guild() then
				return cost * 0.9
			end

			return cost
		end

		function GetOreRefineGoodPct()
			return 60
		end

		function GetOreRefineBadPct()
			return 30
		end

		function GetMyRefineNum(race)
			return race - 20060 + 50601
		end

		function IsRefinableRawOre(vnum)
			return vnum >= 50601 and vnum <= 50619
		end

		function DoRefineDiamond(pct)
			local from_postfix
			local from_name = item_name(item.get_vnum())
			local to_vnum = item.get_vnum() + 20
			local to_name = item_name(to_vnum)
			local to_postfix

			say(locale_quest(1643))

			if item.count >= 100 then
				say(string.format(locale_quest(1653), pct, guild_building_melt.GetOreRefineCost(10000)))

				local s = select(locale_quest(2625), locale_quest(2600))

				if s == 1 then
					if pc.get_gold() < guild_building_melt.GetOreRefineCost(10000) then
						say(locale_quest(1664))
						return
					end

					if pc.diamond_refine(10000, pct) then
						say(locale_quest(1645))
						say_item(to_name, to_vnum, "")
					else
						say(locale_quest(1672))
					end
				end
			else
				say(string.format(locale_quest(1673), from_name))
			end
		end

		function DoRefine(pct)
			local from_postfix
			local from_name = item_name(item.get_vnum())
			local to_vnum = item.get_vnum() + 20
			local to_name = item_name(to_vnum)
			local to_postfix

			say(string.format(locale_quest(1674), from_name, to_name))

			if item.get_count() >= 100 then
				say(string.format(locale_quest(1653), pct, guild_building_melt.GetOreRefineCost(3000)))

				local s = select(locale_quest(2625), locale_quest(2600))

				if s == 1 then
					if pc.get_gold() < guild_building_melt.GetOreRefineCost(3000) then
						say(locale_quest(1664))
						return
					end

					local selected_item_cell = select_item()

					if selected_item_cell == 0 then
						say(locale_quest(1675))
						return
					end

					local old_item = item.get_id()

					if (not item.select_cell(selected_item_cell)) or item.get_vnum() < 28000 or item.get_vnum() >= 28300 then
						say(locale_quest(1644))
						return
					end

					item.select(old_item, old_item)

					if pc.ore_refine(3000, pct, selected_item_cell) then
						say(locale_quest(1671))
						say_item(to_name, to_vnum, "")
					else
						say(locale_quest(1672))
					end
				end
			else
				say(string.format(locale_quest(1673), from_name))
			end
		end

		when
			20060.take or
			20061.take or
			20062.take or
			20063.take or
			20064.take or
			20065.take or
			20066.take or
			20067.take or
			20068.take or
			20069.take or
			20070.take or
			20071.take or
			20072.take
			with guild_building_melt.GetMyRefineNum(npc.get_race()) == item.get_vnum()
		begin
			if item.get_vnum() == 50601 then
				guild_building_melt.DoRefineDiamond(guild_building_melt.GetOreRefineGoodPct())
			else
				guild_building_melt.DoRefine(guild_building_melt.GetOreRefineGoodPct())
			end
		end

		when
			20060.take or
			20061.take or
			20062.take or
			20063.take or
			20064.take or
			20065.take or
			20066.take or
			20067.take or
			20068.take or
			20069.take or
			20070.take or
			20071.take or
			20072.take
			with guild_building_melt.IsRefinableRawOre(item.get_vnum()) and guild_building_melt.GetMyRefineNum(npc.get_race()) != item.get_vnum()
		begin
			if item.get_vnum() == 50601 then
				guild_building_melt.DoRefineDiamond(guild_building_melt.GetOreRefineBadPct())
			else
				guild_building_melt.DoRefine(guild_building_melt.GetOreRefineBadPct())
			end
		end

		when
			20060.click or
			20061.click or
			20062.click or
			20063.click or
			20064.click or
			20065.click or
			20066.click or
			20067.click or
			20068.click or
			20069.click or
			20070.click or
			20071.click or
			20072.click
			with npc.get_guild() == pc.get_guild() and pc.isguildmaster()
		begin
			say(locale_quest(1646))

			if pc.get_gold() < 3000000 then
				say(locale_quest(1647))
			else
				say(locale_quest(1648))

				local sel = 0

				local timetable1 = {
					locale_quest(1651),
					locale_quest(1652),
					locale_quest(1654),
					locale_quest(1655),
					locale_quest(1656),
					locale_quest(1657),
					locale_quest(2669),
					locale_quest(1650)
				}
				local valuetable1 = { 14043, 14045, 14046, 14047, 14048, 14049, 0, -1 }

				local timetable2 = {
					locale_quest(1658),
					locale_quest(1659),
					locale_quest(1660),
					locale_quest(1661),
					locale_quest(1662),
					locale_quest(1663),
					locale_quest(2669),
					locale_quest(1650)
				}
				local valuetable2 = { 14050, 14051, 14052, 14053, 14054, 14055, 0, -1 }

				local timetable3 = {
					locale_quest(1665),
					locale_quest(1666),
					locale_quest(1667),
					locale_quest(1668),
					locale_quest(1669),
					locale_quest(1670),
					locale_quest(2669),
					locale_quest(1650)
				}
				local valuetable3 = { 14056, 14057, 14058, 14059, 14060, 14055, 0, -1 }

				repeat
					local s = select_table(timetable1)
					sel = valuetable1[s]
					if sel == 0 then
						local s = select_table(timetable2)
						sel = valuetable2[s]
						if sel == 0 then
							local s = select_table(timetable3)
							sel = valuetable3[s]
						end
					end
				until sel != 0

				if sel != -1 then
					npc_num = sel + 20060 - 14043
					if npc_num == npc.get_race() then
						say(locale_quest(1649))
					else
						pc.changegold(-3000000)
						building.reconstruct(sel)
					end
				end
			end
		end
	end
end
